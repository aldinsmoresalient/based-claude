# Build Repo Atlas

You are generating a **Repo Atlas** - a persistent, grep-friendly codebase index that helps agents (including yourself) re-orient quickly after context loss.

## Core Purpose

The Atlas answers these questions in SECONDS:
1. **"What is this system?"** - Overview, purpose, architecture
2. **"Where should I look?"** - Entry points, domains, folder purposes
3. **"What matters?"** - Critical paths, hot files, integration points
4. **"What must NOT be broken?"** - High-risk areas, invariants, protected paths

This is NOT a search index. It's an ORIENTATION document.

---

## Step 1: Explore the Codebase

```bash
# Understand structure (ignore node_modules, dist, etc.)
ls -la
find . -type f -name "*.ts" -o -name "*.js" -o -name "*.py" -o -name "*.go" | grep -v node_modules | grep -v dist | head -50

# Find entry points
cat package.json 2>/dev/null | head -30
cat pyproject.toml 2>/dev/null | head -30
ls src/ 2>/dev/null
```

Read key files to understand what this codebase DOES, not just what files exist.

---

## Step 2: Generate Root Atlas

Create `.claude-sdk/ATLAS.md` with this EXACT format:

```markdown
# REPO ATLAS
# Generated by Claude - Human-editable
# Re-run "build the atlas" to refresh (preserves NOTES section)

BUILT: [ISO timestamp]
COMMIT: [git hash or "not-a-repo"]
TYPE: [node|python|go|rust|java|mixed]

## OVERVIEW

PROJECT: [name]
PURPOSE: [One sentence - what does this system DO?]
ARCHITECTURE: [One sentence - key architectural pattern]

## ENTRY POINTS

# Where to start reading this codebase:
ENTRY: [file] # [why this is an entry point]
ENTRY: [file] # [why]

## MAJOR DOMAINS

# Top-level organization - what are the major subsystems?
DOMAIN: [path/] # [one-line purpose]
DOMAIN: [path/] # [one-line purpose]

## CRITICAL PATHS

# Code that is high-risk, load-bearing, or frequently changed:
CRITICAL: [path] # [why - e.g., "auth logic", "payment processing"]
CRITICAL: [path] # [why]

## CROSS-CUTTING CONCERNS

# Where does logging, auth, error handling, etc. live?
CONCERN: auth -> [path]
CONCERN: logging -> [path]
CONCERN: errors -> [path]
CONCERN: config -> [path]

## DATA FLOW

# How does data move through the system?
FLOW: [source] -> [transform] -> [destination]

## EXTERNAL INTEGRATIONS

# What external services/APIs does this connect to?
EXTERNAL: [service] # [where handled]

## SEARCH ANCHORS

# Grep patterns for navigating this codebase:
GREP: "[pattern]" # [what it finds]
GREP: "[pattern]" # [what it finds]

## RELATED MEMORY

# Links to other Based Claude files:
DECISIONS: .claude-sdk/memory/DECISIONS.md
INVARIANTS: .claude-sdk/memory/INVARIANTS.md
TASKS: .claude-sdk/memory/TASKS.md
CONTRACT: .claude-sdk/CONTRACT.md

## NOTES

[Preserve this section across rebuilds. Add architectural notes,
gotchas, tribal knowledge, or anything future-you needs to know.]

```

---

## Step 3: Generate Folder Maps

For each MAJOR folder (not every folder), create `.claude-sdk/atlas/[folder-name].atlas.md`:

```markdown
# FOLDER: [path]

PURPOSE: [1-2 sentences - what does this folder DO?]
LAYER: [presentation|business|data|infrastructure|test|config]
RISK: [low|medium|high|critical]
OWNER: [team or "unassigned"]

## KEY FILES

# Most important files in this folder:
FILE: [name] # [one-line purpose]
FILE: [name] # [purpose]

## PUBLIC INTERFACE

# What does this folder expose to other parts of the codebase?
EXPORT: [symbol/function/class] # [what it does]
ROUTE: [path] [METHOD] # [handler] (if applicable)
EVENT: [event-name] # [emitted when]

## DEPENDENCIES

# What does this folder depend on?
DEPENDS_ON: [internal path] # [why]
DEPENDS_ON: [external package] # [why]

## DEPENDED ON BY

# What depends on this folder?
USED_BY: [path] # [how]

## PATTERNS

# Important patterns or conventions in this folder:
PATTERN: [description]

## INVARIANTS

# Rules that must not be violated in this folder:
INVARIANT: [rule]

## SEARCH ANCHORS

# Grep patterns specific to this folder:
GREP: "[pattern]" in [path] # [what it finds]

## NOTES

[Folder-specific notes, gotchas, or context]
```

---

## Step 4: Assess Risk

Mark folders/files as high-risk if they involve:
- **Authentication/Authorization** - RISK: critical
- **Payment/Billing** - RISK: critical
- **Data mutations** - RISK: high
- **External API integrations** - RISK: high
- **Database schemas/migrations** - RISK: high
- **Security configurations** - RISK: critical
- **Public API surfaces** - RISK: medium

---

## Step 5: Identify Invariants

While building the atlas, note any invariants you discover:
- "All database writes go through X"
- "Auth checks happen in middleware Y"
- "Config is only read from Z"

Add these to `.claude-sdk/memory/INVARIANTS.md`.

---

## Exclusions (NEVER index these)

- `node_modules/`, `vendor/`, `.venv/`
- `dist/`, `build/`, `target/`, `out/`
- `.git/`
- `*.min.js`, `*.map`
- `.env`, `*.pem`, `*.key`, credentials
- `coverage/`, `__pycache__/`

Check `.gitignore` for project-specific exclusions.

---

## Format Rules (CRITICAL)

1. **One concept per line** - No paragraphs in the structured sections
2. **Deterministic prefixes** - Always use ENTRY:, DOMAIN:, FILE:, EXPORT:, etc.
3. **Grep-friendly** - Someone should be able to `grep "^ROUTE:" ATLAS.md`
4. **Minimal prose** - Save explanations for NOTES sections
5. **Stable across rebuilds** - Same input = same output (except timestamps)

---

## After Generation

Tell the user:
1. Atlas created at `.claude-sdk/ATLAS.md`
2. Folder maps at `.claude-sdk/atlas/`
3. Review and edit the NOTES sections
4. Add project-specific INVARIANTS
5. Run "refresh the atlas" after major changes
